{"version":3,"file":"history.js","sources":["../../src/history.ts"],"sourcesContent":["// While the public API was clearly inspired by the \"history\" npm package,\n// This implementation attempts to be more lightweight by\n// making assumptions about the way TanStack Router works\n\nexport interface RouterHistory {\n  location: RouterLocation\n  listen: (cb: () => void) => () => void\n  push: (path: string, state?: any) => void\n  replace: (path: string, state?: any) => void\n  go: (index: number) => void\n  back: () => void\n  forward: () => void\n  createHref: (href: string) => string\n  block: (blockerFn: BlockerFn) => () => void\n}\n\nexport interface ParsedPath {\n  href: string\n  pathname: string\n  search: string\n  hash: string\n}\n\nexport interface RouterLocation extends ParsedPath {\n  state: any\n}\n\ntype BlockerFn = (retry: () => void, cancel: () => void) => void\n\nconst popStateEvent = 'popstate'\nconst beforeUnloadEvent = 'beforeunload'\n\nconst beforeUnloadListener = (event: Event) => {\n  event.preventDefault()\n  // @ts-ignore\n  return (event.returnValue = '')\n}\n\nconst stopBlocking = () => {\n  removeEventListener(beforeUnloadEvent, beforeUnloadListener, {\n    capture: true,\n  })\n}\n\nfunction createHistory(opts: {\n  getLocation: () => RouterLocation\n  listener: (onUpdate: () => void) => () => void\n  pushState: (path: string, state: any) => void\n  replaceState: (path: string, state: any) => void\n  go: (n: number) => void\n  back: () => void\n  forward: () => void\n  createHref: (path: string) => string\n}): RouterHistory {\n  let location = opts.getLocation()\n  let unsub = () => {}\n  let listeners = new Set<() => void>()\n  let blockers: BlockerFn[] = []\n  let queue: (() => void)[] = []\n\n  const tryFlush = () => {\n    if (blockers.length) {\n      blockers[0]?.(tryFlush, () => {\n        blockers = []\n        stopBlocking()\n      })\n      return\n    }\n\n    while (queue.length) {\n      queue.shift()?.()\n    }\n\n    onUpdate()\n  }\n\n  const queueTask = (task: () => void) => {\n    queue.push(task)\n    tryFlush()\n  }\n\n  const onUpdate = () => {\n    location = opts.getLocation()\n    listeners.forEach((listener) => listener())\n  }\n\n  return {\n    get location() {\n      return location\n    },\n    listen: (cb: () => void) => {\n      if (listeners.size === 0) {\n        unsub = opts.listener(onUpdate)\n      }\n      listeners.add(cb)\n\n      return () => {\n        listeners.delete(cb)\n        if (listeners.size === 0) {\n          unsub()\n        }\n      }\n    },\n    push: (path: string, state: any) => {\n      queueTask(() => {\n        opts.pushState(path, state)\n      })\n    },\n    replace: (path: string, state: any) => {\n      queueTask(() => {\n        opts.replaceState(path, state)\n      })\n    },\n    go: (index) => {\n      queueTask(() => {\n        opts.go(index)\n      })\n    },\n    back: () => {\n      queueTask(() => {\n        opts.back()\n      })\n    },\n    forward: () => {\n      queueTask(() => {\n        opts.forward()\n      })\n    },\n    createHref: (str) => opts.createHref(str),\n    block: (cb) => {\n      blockers.push(cb)\n\n      if (blockers.length === 1) {\n        addEventListener(beforeUnloadEvent, beforeUnloadListener, {\n          capture: true,\n        })\n      }\n\n      return () => {\n        blockers = blockers.filter((b) => b !== cb)\n\n        if (!blockers.length) {\n          stopBlocking()\n        }\n      }\n    },\n  }\n}\n\nexport function createBrowserHistory(opts?: {\n  getHref?: () => string\n  createHref?: (path: string) => string\n}): RouterHistory {\n  const getHref =\n    opts?.getHref ??\n    (() =>\n      `${window.location.pathname}${window.location.search}${window.location.hash}`)\n  const createHref = opts?.createHref ?? ((path) => path)\n  const getLocation = () => parseLocation(getHref(), history.state)\n\n  return createHistory({\n    getLocation,\n    listener: (onUpdate) => {\n      window.addEventListener(popStateEvent, onUpdate)\n      return () => {\n        window.removeEventListener(popStateEvent, onUpdate)\n      }\n    },\n    pushState: (path, state) => {\n      window.history.pushState(\n        { ...state, key: createRandomKey() },\n        '',\n        createHref(path),\n      )\n    },\n    replaceState: (path, state) => {\n      window.history.replaceState(\n        { ...state, key: createRandomKey() },\n        '',\n        createHref(path),\n      )\n    },\n    back: () => window.history.back(),\n    forward: () => window.history.forward(),\n    go: (n) => window.history.go(n),\n    createHref: (path) => createHref(path),\n  })\n}\n\nexport function createHashHistory(): RouterHistory {\n  return createBrowserHistory({\n    getHref: () => window.location.hash.substring(1),\n    createHref: (path) => `#${path}`,\n  })\n}\n\nexport function createMemoryHistory(\n  opts: {\n    initialEntries: string[]\n    initialIndex?: number\n  } = {\n    initialEntries: ['/'],\n  },\n): RouterHistory {\n  const entries = opts.initialEntries\n  let index = opts.initialIndex ?? entries.length - 1\n  let currentState = {}\n\n  const getLocation = () => parseLocation(entries[index]!, currentState)\n\n  return createHistory({\n    getLocation,\n    listener: () => {\n      return () => {}\n    },\n    pushState: (path, state) => {\n      currentState = {\n        ...state,\n        key: createRandomKey(),\n      }\n      entries.push(path)\n      index++\n    },\n    replaceState: (path, state) => {\n      currentState = {\n        ...state,\n        key: createRandomKey(),\n      }\n      entries[index] = path\n    },\n    back: () => {\n      index--\n    },\n    forward: () => {\n      index = Math.min(index + 1, entries.length - 1)\n    },\n    go: (n) => window.history.go(n),\n    createHref: (path) => path,\n  })\n}\n\nfunction parseLocation(href: string, state: any): RouterLocation {\n  let hashIndex = href.indexOf('#')\n  let searchIndex = href.indexOf('?')\n\n  return {\n    href,\n    pathname: href.substring(\n      0,\n      hashIndex > 0\n        ? searchIndex > 0\n          ? Math.min(hashIndex, searchIndex)\n          : hashIndex\n        : searchIndex > 0\n        ? searchIndex\n        : href.length,\n    ),\n    hash: hashIndex > -1 ? href.substring(hashIndex) : '',\n    search:\n      searchIndex > -1\n        ? href.slice(searchIndex, hashIndex === -1 ? undefined : hashIndex)\n        : '',\n    state,\n  }\n}\n\n// Thanks co-pilot!\nfunction createRandomKey() {\n  return (Math.random() + 1).toString(36).substring(7)\n}\n"],"names":["popStateEvent","beforeUnloadEvent","beforeUnloadListener","event","preventDefault","returnValue","stopBlocking","removeEventListener","capture","createHistory","opts","location","getLocation","unsub","listeners","Set","blockers","queue","tryFlush","length","shift","onUpdate","queueTask","task","push","forEach","listener","listen","cb","size","add","delete","path","state","pushState","replace","replaceState","go","index","back","forward","createHref","str","block","addEventListener","filter","b","createBrowserHistory","getHref","window","pathname","search","hash","parseLocation","history","key","createRandomKey","n","createHashHistory","substring","createMemoryHistory","initialEntries","entries","initialIndex","currentState","Math","min","href","hashIndex","indexOf","searchIndex","slice","undefined","random","toString"],"mappings":"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"}