{"version":3,"file":"routeMatch.js","sources":["../../src/routeMatch.ts"],"sourcesContent":["import { Store } from '@tanstack/react-store'\n//\nimport { RouteComponent } from './react'\nimport { AnyRoute, Route, StreamedPromise } from './route'\nimport { AnyRoutesInfo, DefaultRoutesInfo } from './routeInfo'\nimport { AnyRouter, isRedirect, ParsedLocation, Router } from './router'\nimport { replaceEqualDeep } from './utils'\n\nexport interface RouteMatchState<\n  TRoutesInfo extends AnyRoutesInfo = DefaultRoutesInfo,\n  TRoute extends AnyRoute = Route,\n> {\n  routeSearch: TRoute['__types']['searchSchema']\n  search: TRoutesInfo['fullSearchSchema'] &\n    TRoute['__types']['fullSearchSchema']\n  status: 'pending' | 'success' | 'error'\n  error?: unknown\n  updatedAt: number\n  loader: TRoute['__types']['loader']\n}\n\nconst componentTypes = [\n  'component',\n  'errorComponent',\n  'pendingComponent',\n] as const\n\nexport interface PendingRouteMatchInfo {\n  state: RouteMatchState<any, any>\n  routeContext: {}\n  context: {}\n}\n\nexport interface AnyRouteMatch extends RouteMatch<any, any> {}\n\nexport class RouteMatch<\n  TRoutesInfo extends AnyRoutesInfo = DefaultRoutesInfo,\n  TRoute extends AnyRoute = AnyRoute,\n> {\n  route!: TRoute\n  router!: Router<TRoutesInfo['routeTree'], TRoutesInfo>\n  __store!: Store<RouteMatchState<TRoutesInfo, TRoute>>\n  state!: RouteMatchState<TRoutesInfo, TRoute>\n  id!: string\n  pathname!: string\n  params!: TRoute['__types']['allParams']\n\n  routeContext?: TRoute['__types']['routeContext']\n  context!: TRoute['__types']['context']\n\n  component?: RouteComponent<{\n    useLoader: TRoute['useLoader']\n    useMatch: TRoute['useMatch']\n    useContext: TRoute['useContext']\n    useSearch: TRoute['useSearch']\n    useParams: TRoute['useParams']\n  }>\n  errorComponent?: RouteComponent<{\n    error: Error\n    info: { componentStack: string }\n  }>\n  pendingComponent?: RouteComponent\n  abortController = new AbortController()\n  parentMatch?: RouteMatch\n  pendingInfo?: PendingRouteMatchInfo\n\n  // __promiseKeys: string[] = []\n  // __promisesByKey: Record<string, StreamedPromise<any>> = {}\n  __loadPromise?: Promise<void>\n  __loadPromiseResolve?: () => void\n  __onExit?:\n    | void\n    | ((matchContext: {\n        params: TRoute['__types']['allParams']\n        search: TRoute['__types']['fullSearchSchema']\n      }) => void)\n\n  constructor(\n    router: AnyRouter,\n    route: TRoute,\n    opts: {\n      id: string\n      params: TRoute['__types']['allParams']\n      pathname: string\n    },\n  ) {\n    Object.assign(this, {\n      route,\n      router,\n      id: opts.id,\n      pathname: opts.pathname,\n      params: opts.params,\n      __store: new Store<RouteMatchState<TRoutesInfo, TRoute>>(\n        {\n          updatedAt: 0,\n          routeSearch: {},\n          search: {} as any,\n          status: 'pending',\n          loader: undefined,\n        },\n        {\n          onUpdate: () => {\n            this.state = this.__store.state\n          },\n        },\n      ),\n    })\n\n    this.state = this.__store.state\n\n    componentTypes.map(async (type) => {\n      const component = this.route.options[type]\n\n      this[type] = component as any\n    })\n\n    this.__loadPromise = new Promise((r) => {\n      this.__loadPromiseResolve = r\n    })\n\n    if (this.state.status === 'pending' && !this.#hasLoaders()) {\n      this.__store.setState((s) => ({\n        ...s,\n        status: 'success',\n      }))\n      this.__loadPromiseResolve?.()\n    }\n  }\n\n  #hasLoaders = () => {\n    return !!(\n      this.route.options.loader ||\n      componentTypes.some((d) => this.route.options[d]?.preload)\n    )\n  }\n\n  __commit = () => {\n    const { routeSearch, search, context, routeContext } = this.#resolveInfo({\n      location: this.router.state.location,\n    })\n    this.context = context\n    this.routeContext = routeContext\n    this.__store.setState((s) => ({\n      ...s,\n      routeSearch: replaceEqualDeep(s.routeSearch, routeSearch),\n      search: replaceEqualDeep(s.search, search),\n    }))\n  }\n\n  cancel = () => {\n    this.abortController?.abort()\n  }\n\n  #resolveSearchInfo = (opts: {\n    location: ParsedLocation\n  }): { routeSearch: {}; search: {} } => {\n    // Validate the search params and stabilize them\n    const parentSearchInfo = this.parentMatch\n      ? this.parentMatch.#resolveSearchInfo(opts)\n      : { search: opts.location.search, routeSearch: opts.location.search }\n\n    try {\n      const validator =\n        typeof this.route.options.validateSearch === 'object'\n          ? this.route.options.validateSearch.parse\n          : this.route.options.validateSearch\n\n      const routeSearch = validator?.(parentSearchInfo.search) ?? {}\n\n      const search = {\n        ...parentSearchInfo.search,\n        ...routeSearch,\n      }\n\n      return {\n        routeSearch,\n        search,\n      }\n    } catch (err: any) {\n      if (isRedirect(err)) {\n        throw err\n      }\n\n      const errorHandler =\n        this.route.options.onValidateSearchError ?? this.route.options.onError\n      errorHandler?.(err)\n      const error = new (Error as any)('Invalid search params found', {\n        cause: err,\n      })\n      error.code = 'INVALID_SEARCH_PARAMS'\n\n      throw error\n    }\n  }\n\n  #resolveInfo = (opts: { location: ParsedLocation }) => {\n    const { search, routeSearch } = this.#resolveSearchInfo(opts)\n\n    try {\n      const routeContext =\n        this.route.options.getContext?.({\n          parentContext: this.parentMatch?.routeContext ?? {},\n          context:\n            this.parentMatch?.context ?? this.router?.options.context ?? {},\n          params: this.params,\n          search,\n        }) || ({} as any)\n\n      const context = {\n        ...(this.parentMatch?.context ?? this.router?.options.context),\n        ...routeContext,\n      } as any\n\n      return {\n        routeSearch,\n        search,\n        context,\n        routeContext,\n      }\n    } catch (err) {\n      this.route.options.onError?.(err)\n      throw err\n    }\n  }\n\n  __load = async (opts: {\n    parentMatch: RouteMatch | undefined\n    preload?: boolean\n    location: ParsedLocation\n  }): Promise<void> => {\n    this.parentMatch = opts.parentMatch\n\n    let info\n\n    try {\n      info = this.#resolveInfo(opts)\n    } catch (err) {\n      if (isRedirect(err)) {\n        if (!opts?.preload) {\n          this.router.navigate(err as any)\n        }\n        return\n      }\n\n      this.__store.setState((s) => ({\n        ...s,\n        status: 'error',\n        error: err,\n      }))\n\n      // Do not proceed with loading the route\n      return\n    }\n\n    const { routeSearch, search, context, routeContext } = info\n\n    const loaderOpts = {\n      params: this.params,\n      routeSearch,\n      search,\n      signal: this.abortController.signal,\n      preload: !!opts?.preload,\n      routeContext,\n      context,\n    }\n\n    this.__loadPromise = Promise.resolve().then(async () => {\n      const loadId = '' + Date.now() + Math.random()\n      this.#latestId = loadId\n\n      const checkLatest = () => {\n        return loadId !== this.#latestId ? this.__loadPromise : undefined\n      }\n\n      let latestPromise\n\n      const componentsPromise = (async () => {\n        // then run all component and data loaders in parallel\n        // For each component type, potentially load it asynchronously\n\n        await Promise.all(\n          componentTypes.map(async (type) => {\n            const component = this.route.options[type]\n\n            if (component?.preload) {\n              await component.preload()\n            }\n          }),\n        )\n      })()\n\n      const loaderPromise = Promise.resolve().then(() => {\n        if (this.route.options.loader) {\n          return this.route.options.loader(loaderOpts)\n        }\n        return\n      })\n\n      try {\n        const [_, loader] = await Promise.all([\n          componentsPromise,\n          loaderPromise,\n        ])\n        if ((latestPromise = checkLatest())) return await latestPromise\n\n        // Object.keys(loader ?? {}).forEach((key) => {\n        //   const value = loader[key]\n        //   if (value instanceof Promise || value?.then) {\n        //     // if (this.__promisesByKey[key]) {\n        //     //   return\n        //     // }\n\n        //     if (typeof document === 'undefined') {\n        //       this.__promisesByKey[key] = {\n        //         status: 'pending',\n        //         promise: value,\n        //         data: undefined,\n        //         resolve: () => {},\n        //       }\n\n        //       value.then((d: any) => {\n        //         this.__promisesByKey[key]!.status = 'resolved'\n        //         this.__promisesByKey[key]!.data = d\n        //       })\n        //     } else {\n        //       const promise = createPromise()\n        //       this.__promisesByKey[key] = {\n        //         status: 'pending',\n        //         promise,\n        //         data: undefined,\n        //         resolve: (d: any) => {\n        //           // @ts-ignore\n        //           promise.resolve()\n        //           this.__promisesByKey[key]!.status = 'resolved'\n        //           this.__promisesByKey[key]!.data = d\n        //         },\n        //       }\n\n        //       if (!this.__promiseKeys.includes(key)) {\n        //         value.then(this.__promisesByKey[key]!.resolve)\n        //       }\n        //     }\n\n        //     loader[key] = this.__promisesByKey[key]\n        //   }\n        // })\n\n        if (!opts.preload) {\n          this.__store.setState((s) => ({\n            ...s,\n            error: undefined,\n            status: 'success',\n            updatedAt: Date.now(),\n            loader,\n          }))\n        }\n      } catch (err) {\n        if (isRedirect(err)) {\n          if (!opts?.preload) {\n            this.router.navigate(err as any)\n          }\n          return\n        }\n\n        const errorHandler =\n          this.route.options.onLoadError ?? this.route.options.onError\n        try {\n          errorHandler?.(err)\n        } catch (errorHandlerErr) {\n          if (isRedirect(errorHandlerErr)) {\n            if (!opts?.preload) {\n              this.router.navigate(errorHandlerErr as any)\n            }\n            return\n          }\n\n          this.__store.setState((s) => ({\n            ...s,\n            error: errorHandlerErr,\n            status: 'error',\n            updatedAt: Date.now(),\n          }))\n          return\n        }\n\n        this.__store.setState((s) => ({\n          ...s,\n          error: err,\n          status: 'error',\n          updatedAt: Date.now(),\n        }))\n      } finally {\n        this.__loadPromiseResolve?.()\n        delete this.__loadPromise\n      }\n    })\n\n    return this.__loadPromise\n  }\n\n  #latestId = ''\n}\n\ntype ResolvablePromise<T> = Promise<T> & { resolve: (data: T) => void }\n\nfunction createPromise<T>() {\n  let resolve: any\n\n  const promise = new Promise((r) => {\n    resolve = r\n  }) as ResolvablePromise<T>\n\n  promise.resolve = (d: any) => {\n    resolve(d)\n  }\n\n  return promise\n}\n"],"names":["componentTypes","RouteMatch","abortController","AbortController","constructor","router","route","opts","Object","assign","id","pathname","params","__store","Store","updatedAt","routeSearch","search","status","loader","undefined","onUpdate","state","map","type","component","options","__loadPromise","Promise","r","__loadPromiseResolve","setState","s","some","d","preload","__commit","context","routeContext","location","replaceEqualDeep","cancel","abort","parentSearchInfo","parentMatch","validator","validateSearch","parse","err","isRedirect","errorHandler","onValidateSearchError","onError","error","Error","cause","code","getContext","parentContext","__load","info","navigate","loaderOpts","signal","resolve","then","loadId","Date","now","Math","random","checkLatest","latestPromise","componentsPromise","all","loaderPromise","_","onLoadError","errorHandlerErr"],"mappings":";;;;;;;;;;;;;;;;;;AAqBA,MAAMA,cAAc,GAAG,CACrB,WAAW,EACX,gBAAgB,EAChB,kBAAkB,CACV,CAAA;AAUH,MAAMC,UAAU,CAGrB;EAwBAC,eAAe,GAAG,IAAIC,eAAe,EAAE,CAAA;AAevCC,EAAAA,WAAW,CACTC,MAAiB,EACjBC,KAAa,EACbC,IAIC,EACD;AACAC,IAAAA,MAAM,CAACC,MAAM,CAAC,IAAI,EAAE;MAClBH,KAAK;MACLD,MAAM;MACNK,EAAE,EAAEH,IAAI,CAACG,EAAE;MACXC,QAAQ,EAAEJ,IAAI,CAACI,QAAQ;MACvBC,MAAM,EAAEL,IAAI,CAACK,MAAM;MACnBC,OAAO,EAAE,IAAIC,gBAAK,CAChB;AACEC,QAAAA,SAAS,EAAE,CAAC;QACZC,WAAW,EAAE,EAAE;QACfC,MAAM,EAAE,EAAS;AACjBC,QAAAA,MAAM,EAAE,SAAS;AACjBC,QAAAA,MAAM,EAAEC,SAAAA;AACV,OAAC,EACD;AACEC,QAAAA,QAAQ,EAAE,MAAM;AACd,UAAA,IAAI,CAACC,KAAK,GAAG,IAAI,CAACT,OAAO,CAACS,KAAK,CAAA;AACjC,SAAA;OACD,CAAA;AAEL,KAAC,CAAC,CAAA;AAEF,IAAA,IAAI,CAACA,KAAK,GAAG,IAAI,CAACT,OAAO,CAACS,KAAK,CAAA;AAE/BtB,IAAAA,cAAc,CAACuB,GAAG,CAAC,MAAOC,IAAI,IAAK;MACjC,MAAMC,SAAS,GAAG,IAAI,CAACnB,KAAK,CAACoB,OAAO,CAACF,IAAI,CAAC,CAAA;AAE1C,MAAA,IAAI,CAACA,IAAI,CAAC,GAAGC,SAAgB,CAAA;AAC/B,KAAC,CAAC,CAAA;AAEF,IAAA,IAAI,CAACE,aAAa,GAAG,IAAIC,OAAO,CAAEC,CAAC,IAAK;MACtC,IAAI,CAACC,oBAAoB,GAAGD,CAAC,CAAA;AAC/B,KAAC,CAAC,CAAA;AAEF,IAAA,IAAI,IAAI,CAACP,KAAK,CAACJ,MAAM,KAAK,SAAS,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,EAAE;AAC1D,MAAA,IAAI,CAACL,OAAO,CAACkB,QAAQ,CAAEC,CAAC,KAAM;AAC5B,QAAA,GAAGA,CAAC;AACJd,QAAAA,MAAM,EAAE,SAAA;AACV,OAAC,CAAC,CAAC,CAAA;MACH,IAAI,CAACY,oBAAoB,IAAI,CAAA;AAC/B,KAAA;AACF,GAAA;EAEA,WAAW,GAAG,MAAM;IAClB,OAAO,CAAC,EACN,IAAI,CAACxB,KAAK,CAACoB,OAAO,CAACP,MAAM,IACzBnB,cAAc,CAACiC,IAAI,CAAEC,CAAC,IAAK,IAAI,CAAC5B,KAAK,CAACoB,OAAO,CAACQ,CAAC,CAAC,EAAEC,OAAO,CAAC,CAC3D,CAAA;GACF,CAAA;AAEDC,EAAAA,QAAQ,GAAG,MAAM;IACf,MAAM;MAAEpB,WAAW;MAAEC,MAAM;MAAEoB,OAAO;AAAEC,MAAAA,YAAAA;AAAa,KAAC,GAAG,IAAI,CAAC,YAAY,CAAC;AACvEC,MAAAA,QAAQ,EAAE,IAAI,CAAClC,MAAM,CAACiB,KAAK,CAACiB,QAAAA;AAC9B,KAAC,CAAC,CAAA;IACF,IAAI,CAACF,OAAO,GAAGA,OAAO,CAAA;IACtB,IAAI,CAACC,YAAY,GAAGA,YAAY,CAAA;AAChC,IAAA,IAAI,CAACzB,OAAO,CAACkB,QAAQ,CAAEC,CAAC,KAAM;AAC5B,MAAA,GAAGA,CAAC;MACJhB,WAAW,EAAEwB,sBAAgB,CAACR,CAAC,CAAChB,WAAW,EAAEA,WAAW,CAAC;AACzDC,MAAAA,MAAM,EAAEuB,sBAAgB,CAACR,CAAC,CAACf,MAAM,EAAEA,MAAM,CAAA;AAC3C,KAAC,CAAC,CAAC,CAAA;GACJ,CAAA;AAEDwB,EAAAA,MAAM,GAAG,MAAM;AACb,IAAA,IAAI,CAACvC,eAAe,EAAEwC,KAAK,EAAE,CAAA;GAC9B,CAAA;EAED,kBAAkB,GAAInC,IAErB,IAAsC;AACrC;AACA,IAAA,MAAMoC,gBAAgB,GAAG,IAAI,CAACC,WAAW,GACrC,IAAI,CAACA,WAAW,CAAC,kBAAkB,CAACrC,IAAI,CAAC,GACzC;AAAEU,MAAAA,MAAM,EAAEV,IAAI,CAACgC,QAAQ,CAACtB,MAAM;AAAED,MAAAA,WAAW,EAAET,IAAI,CAACgC,QAAQ,CAACtB,MAAAA;KAAQ,CAAA;IAEvE,IAAI;AACF,MAAA,MAAM4B,SAAS,GACb,OAAO,IAAI,CAACvC,KAAK,CAACoB,OAAO,CAACoB,cAAc,KAAK,QAAQ,GACjD,IAAI,CAACxC,KAAK,CAACoB,OAAO,CAACoB,cAAc,CAACC,KAAK,GACvC,IAAI,CAACzC,KAAK,CAACoB,OAAO,CAACoB,cAAc,CAAA;MAEvC,MAAM9B,WAAW,GAAG6B,SAAS,GAAGF,gBAAgB,CAAC1B,MAAM,CAAC,IAAI,EAAE,CAAA;AAE9D,MAAA,MAAMA,MAAM,GAAG;QACb,GAAG0B,gBAAgB,CAAC1B,MAAM;QAC1B,GAAGD,WAAAA;OACJ,CAAA;MAED,OAAO;QACLA,WAAW;AACXC,QAAAA,MAAAA;OACD,CAAA;KACF,CAAC,OAAO+B,GAAQ,EAAE;AACjB,MAAA,IAAIC,iBAAU,CAACD,GAAG,CAAC,EAAE;AACnB,QAAA,MAAMA,GAAG,CAAA;AACX,OAAA;AAEA,MAAA,MAAME,YAAY,GAChB,IAAI,CAAC5C,KAAK,CAACoB,OAAO,CAACyB,qBAAqB,IAAI,IAAI,CAAC7C,KAAK,CAACoB,OAAO,CAAC0B,OAAO,CAAA;MACxEF,YAAY,GAAGF,GAAG,CAAC,CAAA;AACnB,MAAA,MAAMK,KAAK,GAAG,IAAKC,KAAK,CAAS,6BAA6B,EAAE;AAC9DC,QAAAA,KAAK,EAAEP,GAAAA;AACT,OAAC,CAAC,CAAA;MACFK,KAAK,CAACG,IAAI,GAAG,uBAAuB,CAAA;AAEpC,MAAA,MAAMH,KAAK,CAAA;AACb,KAAA;GACD,CAAA;EAED,YAAY,GAAI9C,IAAkC,IAAK;IACrD,MAAM;MAAEU,MAAM;AAAED,MAAAA,WAAAA;AAAY,KAAC,GAAG,IAAI,CAAC,kBAAkB,CAACT,IAAI,CAAC,CAAA;IAE7D,IAAI;MACF,MAAM+B,YAAY,GAChB,IAAI,CAAChC,KAAK,CAACoB,OAAO,CAAC+B,UAAU,GAAG;QAC9BC,aAAa,EAAE,IAAI,CAACd,WAAW,EAAEN,YAAY,IAAI,EAAE;AACnDD,QAAAA,OAAO,EACL,IAAI,CAACO,WAAW,EAAEP,OAAO,IAAI,IAAI,CAAChC,MAAM,EAAEqB,OAAO,CAACW,OAAO,IAAI,EAAE;QACjEzB,MAAM,EAAE,IAAI,CAACA,MAAM;AACnBK,QAAAA,MAAAA;OACD,CAAC,IAAK,EAAU,CAAA;AAEnB,MAAA,MAAMoB,OAAO,GAAG;AACd,QAAA,IAAI,IAAI,CAACO,WAAW,EAAEP,OAAO,IAAI,IAAI,CAAChC,MAAM,EAAEqB,OAAO,CAACW,OAAO,CAAC;QAC9D,GAAGC,YAAAA;OACG,CAAA;MAER,OAAO;QACLtB,WAAW;QACXC,MAAM;QACNoB,OAAO;AACPC,QAAAA,YAAAA;OACD,CAAA;KACF,CAAC,OAAOU,GAAG,EAAE;MACZ,IAAI,CAAC1C,KAAK,CAACoB,OAAO,CAAC0B,OAAO,GAAGJ,GAAG,CAAC,CAAA;AACjC,MAAA,MAAMA,GAAG,CAAA;AACX,KAAA;GACD,CAAA;EAEDW,MAAM,GAAG,MAAOpD,IAIf,IAAoB;AACnB,IAAA,IAAI,CAACqC,WAAW,GAAGrC,IAAI,CAACqC,WAAW,CAAA;AAEnC,IAAA,IAAIgB,IAAI,CAAA;IAER,IAAI;AACFA,MAAAA,IAAI,GAAG,IAAI,CAAC,YAAY,CAACrD,IAAI,CAAC,CAAA;KAC/B,CAAC,OAAOyC,GAAG,EAAE;AACZ,MAAA,IAAIC,iBAAU,CAACD,GAAG,CAAC,EAAE;AACnB,QAAA,IAAI,CAACzC,IAAI,EAAE4B,OAAO,EAAE;AAClB,UAAA,IAAI,CAAC9B,MAAM,CAACwD,QAAQ,CAACb,GAAG,CAAQ,CAAA;AAClC,SAAA;AACA,QAAA,OAAA;AACF,OAAA;AAEA,MAAA,IAAI,CAACnC,OAAO,CAACkB,QAAQ,CAAEC,CAAC,KAAM;AAC5B,QAAA,GAAGA,CAAC;AACJd,QAAAA,MAAM,EAAE,OAAO;AACfmC,QAAAA,KAAK,EAAEL,GAAAA;AACT,OAAC,CAAC,CAAC,CAAA;;AAEH;AACA,MAAA,OAAA;AACF,KAAA;IAEA,MAAM;MAAEhC,WAAW;MAAEC,MAAM;MAAEoB,OAAO;AAAEC,MAAAA,YAAAA;AAAa,KAAC,GAAGsB,IAAI,CAAA;AAE3D,IAAA,MAAME,UAAU,GAAG;MACjBlD,MAAM,EAAE,IAAI,CAACA,MAAM;MACnBI,WAAW;MACXC,MAAM;AACN8C,MAAAA,MAAM,EAAE,IAAI,CAAC7D,eAAe,CAAC6D,MAAM;AACnC5B,MAAAA,OAAO,EAAE,CAAC,CAAC5B,IAAI,EAAE4B,OAAO;MACxBG,YAAY;AACZD,MAAAA,OAAAA;KACD,CAAA;IAED,IAAI,CAACV,aAAa,GAAGC,OAAO,CAACoC,OAAO,EAAE,CAACC,IAAI,CAAC,YAAY;AACtD,MAAA,MAAMC,MAAM,GAAG,EAAE,GAAGC,IAAI,CAACC,GAAG,EAAE,GAAGC,IAAI,CAACC,MAAM,EAAE,CAAA;AAC9C,MAAA,IAAI,CAAC,SAAS,GAAGJ,MAAM,CAAA;MAEvB,MAAMK,WAAW,GAAG,MAAM;QACxB,OAAOL,MAAM,KAAK,IAAI,CAAC,SAAS,GAAG,IAAI,CAACvC,aAAa,GAAGP,SAAS,CAAA;OAClE,CAAA;AAED,MAAA,IAAIoD,aAAa,CAAA;MAEjB,MAAMC,iBAAiB,GAAG,CAAC,YAAY;AACrC;AACA;;QAEA,MAAM7C,OAAO,CAAC8C,GAAG,CACf1E,cAAc,CAACuB,GAAG,CAAC,MAAOC,IAAI,IAAK;UACjC,MAAMC,SAAS,GAAG,IAAI,CAACnB,KAAK,CAACoB,OAAO,CAACF,IAAI,CAAC,CAAA;UAE1C,IAAIC,SAAS,EAAEU,OAAO,EAAE;YACtB,MAAMV,SAAS,CAACU,OAAO,EAAE,CAAA;AAC3B,WAAA;AACF,SAAC,CAAC,CACH,CAAA;AACH,OAAC,GAAG,CAAA;MAEJ,MAAMwC,aAAa,GAAG/C,OAAO,CAACoC,OAAO,EAAE,CAACC,IAAI,CAAC,MAAM;AACjD,QAAA,IAAI,IAAI,CAAC3D,KAAK,CAACoB,OAAO,CAACP,MAAM,EAAE;UAC7B,OAAO,IAAI,CAACb,KAAK,CAACoB,OAAO,CAACP,MAAM,CAAC2C,UAAU,CAAC,CAAA;AAC9C,SAAA;AACA,QAAA,OAAA;AACF,OAAC,CAAC,CAAA;MAEF,IAAI;AACF,QAAA,MAAM,CAACc,CAAC,EAAEzD,MAAM,CAAC,GAAG,MAAMS,OAAO,CAAC8C,GAAG,CAAC,CACpCD,iBAAiB,EACjBE,aAAa,CACd,CAAC,CAAA;AACF,QAAA,IAAKH,aAAa,GAAGD,WAAW,EAAE,EAAG,OAAO,MAAMC,aAAa,CAAA;;AAE/D;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA,QAAA,IAAI,CAACjE,IAAI,CAAC4B,OAAO,EAAE;AACjB,UAAA,IAAI,CAACtB,OAAO,CAACkB,QAAQ,CAAEC,CAAC,KAAM;AAC5B,YAAA,GAAGA,CAAC;AACJqB,YAAAA,KAAK,EAAEjC,SAAS;AAChBF,YAAAA,MAAM,EAAE,SAAS;AACjBH,YAAAA,SAAS,EAAEoD,IAAI,CAACC,GAAG,EAAE;AACrBjD,YAAAA,MAAAA;AACF,WAAC,CAAC,CAAC,CAAA;AACL,SAAA;OACD,CAAC,OAAO6B,GAAG,EAAE;AACZ,QAAA,IAAIC,iBAAU,CAACD,GAAG,CAAC,EAAE;AACnB,UAAA,IAAI,CAACzC,IAAI,EAAE4B,OAAO,EAAE;AAClB,YAAA,IAAI,CAAC9B,MAAM,CAACwD,QAAQ,CAACb,GAAG,CAAQ,CAAA;AAClC,WAAA;AACA,UAAA,OAAA;AACF,SAAA;AAEA,QAAA,MAAME,YAAY,GAChB,IAAI,CAAC5C,KAAK,CAACoB,OAAO,CAACmD,WAAW,IAAI,IAAI,CAACvE,KAAK,CAACoB,OAAO,CAAC0B,OAAO,CAAA;QAC9D,IAAI;UACFF,YAAY,GAAGF,GAAG,CAAC,CAAA;SACpB,CAAC,OAAO8B,eAAe,EAAE;AACxB,UAAA,IAAI7B,iBAAU,CAAC6B,eAAe,CAAC,EAAE;AAC/B,YAAA,IAAI,CAACvE,IAAI,EAAE4B,OAAO,EAAE;AAClB,cAAA,IAAI,CAAC9B,MAAM,CAACwD,QAAQ,CAACiB,eAAe,CAAQ,CAAA;AAC9C,aAAA;AACA,YAAA,OAAA;AACF,WAAA;AAEA,UAAA,IAAI,CAACjE,OAAO,CAACkB,QAAQ,CAAEC,CAAC,KAAM;AAC5B,YAAA,GAAGA,CAAC;AACJqB,YAAAA,KAAK,EAAEyB,eAAe;AACtB5D,YAAAA,MAAM,EAAE,OAAO;YACfH,SAAS,EAAEoD,IAAI,CAACC,GAAG,EAAA;AACrB,WAAC,CAAC,CAAC,CAAA;AACH,UAAA,OAAA;AACF,SAAA;AAEA,QAAA,IAAI,CAACvD,OAAO,CAACkB,QAAQ,CAAEC,CAAC,KAAM;AAC5B,UAAA,GAAGA,CAAC;AACJqB,UAAAA,KAAK,EAAEL,GAAG;AACV9B,UAAAA,MAAM,EAAE,OAAO;UACfH,SAAS,EAAEoD,IAAI,CAACC,GAAG,EAAA;AACrB,SAAC,CAAC,CAAC,CAAA;AACL,OAAC,SAAS;QACR,IAAI,CAACtC,oBAAoB,IAAI,CAAA;QAC7B,OAAO,IAAI,CAACH,aAAa,CAAA;AAC3B,OAAA;AACF,KAAC,CAAC,CAAA;IAEF,OAAO,IAAI,CAACA,aAAa,CAAA;GAC1B,CAAA;EAED,SAAS,GAAG,EAAE,CAAA;AAChB;;;;"}